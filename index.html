<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noindex, nofollow">
    <title>Password Protected Page</title>
    <style>
        html, body {
            margin: 0;
            width: 100%;
            height: 100%;
            font-family: Arial, Helvetica, sans-serif;
        }
        #dialogText {
            color: white;
            background-color: #333333;
        }
        
        #dialogWrap {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: table;
            background-color: #EEEEEE;
        }
        
        #dialogWrapCell {
            display: table-cell;
            text-align: center;
            vertical-align: middle;
        }
        
        #mainDialog {
            max-width: 400px;
            margin: 5px;
            border: solid #AAAAAA 1px;
            border-radius: 10px;
            box-shadow: 3px 3px 5px 3px #AAAAAA;
            margin-left: auto;
            margin-right: auto;
            background-color: #FFFFFF;
            overflow: hidden;
            text-align: left;
        }
        #mainDialog > * {
            padding: 10px 30px;
        }
        #passArea {
            padding: 20px 30px;
            background-color: white;
        }
        #passArea > * {
            margin: 5px auto;
        }
        #pass {
            width: 100%;
            height: 40px;
            font-size: 30px;
        }
        
        #messageWrapper {
            float: left;
            vertical-align: middle;
            line-height: 30px;
        }
        
        .notifyText {
            display: none;
        }
        
        #invalidPass {
            color: red;
        }
        
        #success {
            color: green;
        }
        
        #submitPass {
            font-size: 20px;
            border-radius: 5px;
            background-color: #E7E7E7;
            border: solid gray 1px;
            float: right;
            cursor: pointer;
        }
        #contentFrame {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #attribution {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            text-align: center;
            padding: 10px;
            font-weight: bold;
            font-size: 0.8em;
        }
        #attribution, #attribution a {
            color: #999;
        }
        .error {
            display: none;
            color: red;
        }
    </style>
  </head>
  <body>
    <iframe id="contentFrame" frameBorder="0" allowfullscreen></iframe>
    <div id="dialogWrap">
        <div id="dialogWrapCell">
            <div id="mainDialog">
                <div id="dialogText">This page is password protected.</div>
                <div id="passArea">
                    <p id="passwordPrompt">Password</p>
                    <input id="pass" type="password" name="pass" autofocus>
                    <div>
                        <span id="messageWrapper">
                            <span id="invalidPass" class="error">Sorry, please try again.</span>
                            <span id="trycatcherror" class="error">Sorry, something went wrong.</span>
                            <span id="success" class="notifyText">Success!</span>
                            &nbsp;
                        </span>
                        <button id="submitPass" type="button">Submit</button>
                        <div style="clear: both;"></div>
                    </div>
                </div>
                <div id="securecontext" class="error">
                    <p>
                        Sorry, but password protection only works over a secure connection. Please load this page via HTTPS.
                    </p>
                </div>
                <div id="nocrypto" class="error">
                    <p>
                        Your web browser appears to be outdated. Please visit this page using a modern browser.
                    </p>
                </div>
            </div>
        </div>
    </div>
    <div id="attribution">
        Protected by <a href="https://www.maxlaumeister.com/pagecrypt/">PageCrypt</a>
    </div>
    <script>
    (function() {

        var pl = "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";
        
        var submitPass = document.getElementById('submitPass');
        var passEl = document.getElementById('pass');
        var invalidPassEl = document.getElementById('invalidPass');
        var trycatcherror = document.getElementById('trycatcherror');
        var successEl = document.getElementById('success');
        var contentFrame = document.getElementById('contentFrame');
        
        // Sanity checks

        if (pl === "") {
            submitPass.disabled = true;
            passEl.disabled = true;
            alert("This page is meant to be used with the encryption tool. It doesn't work standalone.");
            return;
        }

        if (!isSecureContext) {
            document.querySelector("#passArea").style.display = "none";
            document.querySelector("#securecontext").style.display = "block";
            return;
        }

        if (!crypto.subtle) {
            document.querySelector("#passArea").style.display = "none";
            document.querySelector("#nocrypto").style.display = "block";
            return;
        }
        
        function str2ab(str) {
            var ustr = atob(str);
            var buf = new ArrayBuffer(ustr.length);
            var bufView = new Uint8Array(buf);
            for (var i=0, strLen=ustr.length; i < strLen; i++) {
                bufView[i] = ustr.charCodeAt(i);
            }
            return bufView;
        }

        async function deriveKey(salt, password) {
            const encoder = new TextEncoder()
            const baseKey = await crypto.subtle.importKey(
                'raw',
                encoder.encode(password),
                'PBKDF2',
                false,
                ['deriveKey'],
            )
            return await crypto.subtle.deriveKey(
                { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
                baseKey,
                { name: 'AES-GCM', length: 256 },
                true,
                ['decrypt'],
            )
        }
        
        async function doSubmit(evt) {
            submitPass.disabled = true;
            passEl.disabled = true;

            let iv, ciphertext, key;
            
            try {
                var unencodedPl = str2ab(pl);

                const salt = unencodedPl.slice(0, 32)
                iv = unencodedPl.slice(32, 32 + 16)
                ciphertext = unencodedPl.slice(32 + 16)

                key = await deriveKey(salt, passEl.value);
            } catch (e) {
                trycatcherror.style.display = "inline";
                console.error(e);
                return;
            }

            try {
                const decryptedArray = new Uint8Array(
                    await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, ciphertext)
                );

                let decrypted = new TextDecoder().decode(decryptedArray);

                if (decrypted === "") throw "No data returned";

                const basestr = '<base href="." target="_top">';
                const anchorfixstr = `
                    <script>
                        Array.from(document.links).forEach((anchor) => {
                            const href = anchor.getAttribute("href");
                            if (href.startsWith("#")) {
                                anchor.addEventListener("click", function(e) {
                                    e.preventDefault();
                                    const targetId = this.getAttribute("href").substring(1);
                                    const targetEl = document.getElementById(targetId);
                                    targetEl.scrollIntoView();
                                });
                            }
                        });
                    <\/script>
                `;
                
                // Set default iframe link targets to _top so all links break out of the iframe
                if (decrypted.includes("<head>")) decrypted = decrypted.replace("<head>", "<head>" + basestr);
                else if (decrypted.includes("<!DOCTYPE html>")) decrypted = decrypted.replace("<!DOCTYPE html>", "<!DOCTYPE html>" + basestr);
                else decrypted = basestr + decrypted;

                // Fix fragment links
                if (decrypted.includes("</body>")) decrypted = decrypted.replace("</body>", anchorfixstr + '</body>');
                else if (decrypted.includes("</html>")) decrypted = decrypted.replace("</html>", anchorfixstr + '</html>');
                else decrypted = decrypted + anchorfixstr;
                
                contentFrame.srcdoc = decrypted;
                
                successEl.style.display = "inline";
                setTimeout(function() {
                    dialogWrap.style.display = "none";
                }, 1000);
            } catch (e) {
                invalidPassEl.style.display = "inline";
                passEl.value = "";
                submitPass.disabled = false;
                passEl.disabled = false;
                console.error(e);
                return;
            }
        }
        
        submitPass.onclick = doSubmit;
        passEl.onkeypress = function(e){
            if (!e) e = window.event;
            var keyCode = e.keyCode || e.which;
            invalidPassEl.style.display = "none";
            if (keyCode == '13'){
              // Enter pressed
              doSubmit();
              return false;
            }
        }
    })();
    </script>
  </body>
</html>
